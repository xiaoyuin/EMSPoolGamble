<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Pool Gamble - 历史记录</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1em; background-color: #f0f2f5; }
        .card { background: #ffffff; border-radius: 10px; padding: 1.2em; margin-top: 1.5em; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #eee; padding: 0.7em; text-align: center; }
        th { background: #fafafa; font-weight: 500; }
        tr:nth-child(even) { background-color: #fafafa; }
        .header { text-align: center; color: #333; margin-bottom: 1.5em; }
        .links { margin-top: 1em; text-align: center; }
        .links a { color: #1890ff; text-decoration: none; margin: 0 0.5em; }
        .links a:hover { text-decoration: underline; }
        .detail-btn { display: block; padding: 8px 16px; background: #1890ff; color: white; border-radius: 5px; text-decoration: none; margin-top: 1em; text-align: center; width: 100%; box-sizing: border-box; }
        .detail-btn:hover { background: #40a9ff; color: white; text-decoration: none; }
        .footer { margin-top: 2em; text-align: center; font-size: 0.8em; color: #888; }
        .session-header { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .status-active { background: #e6f7ff; color: #1890ff; }
        .status-ended { background: #f5f5f5; color: #666; }
        .score-list { display: flex; flex-wrap: wrap; }
        .score-item { width: 50%; padding: 5px 0; }
        .positive { color: #52c41a; }
        .negative { color: #ff4d4f; }
        .neutral { color: #666; }
        .total-score-table { width: 100%; margin-top: 15px; }
        .total-score-table th { text-align: left; }
        .total-score-table td { text-align: right; }
        .win-rate { color: #666; font-size: 0.9em; }
        .timestamp { font-size: 0.8em; color: #999; margin-top: 5px; }
        .player-link { color: #1890ff; text-decoration: none; }
        .player-link:hover { text-decoration: underline; }
        /* 特殊胜利高亮样式 */
        .player-link.has-small-gold {
            color: #fa8c16 !important;
            text-shadow: 0 0 3px rgba(250, 140, 22, 0.3);
            font-weight: 700;
        }
        .player-link.has-big-gold {
            color: #722ed1 !important;
            text-shadow: 0 0 4px rgba(114, 46, 209, 0.4);
            font-weight: 700;
            background: linear-gradient(135deg, #722ed1, #9254de);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .player-link.has-small-gold:hover {
            color: #d48806 !important;
        }
        .player-link.has-big-gold:hover {
            color: #531dab !important;
            -webkit-text-fill-color: #531dab;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>EMS Pool Gamble - 历史记录</h2>
    </div>

    <!-- 显示消息通知 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card">
        <h3>所有玩家累计分数排名</h3>
        <table class="total-score-table">
            <tr>
                <th>排名</th>
                <th>玩家</th>
                <th>总分</th>
                <th>胜率</th>
            </tr>
            {% for player in total_scores %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    {% if player.id %}
                    <a href="/player/{{ player.id }}" class="player-link{% if player.has_big_gold %} has-big-gold{% elif player.has_small_gold %} has-small-gold{% endif %}">{{ player.name }}</a>
                    {% else %}
                    {{ player.name }}
                    {% endif %}
                </td>
                <td class="{% if player.score > 0 %}positive{% elif player.score < 0 %}negative{% else %}neutral{% endif %}">{{ player.score }}</td>
                <td class="win-rate">{{ "%.1f"|format(player.win_rate) }}%</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    {% for sid, s in sessions.items() %}
    <div class="card">
        <div class="session-header">
            <h4>{{ s.get('name', '未命名场次') }}</h4>
            <span class="status-badge {% if s.active %}status-active{% else %}status-ended{% endif %}">
                {{ '进行中' if s.active else '已结束' }}
            </span>
        </div>
        <div>开始时间: <span data-utc-time="{{ s.timestamp }}">{{ s.timestamp }}</span></div>
        {% if not s.active and s.end_time %}
        <div>结束时间: <span data-utc-time="{{ s.end_time }}">{{ s.end_time }}</span></div>
        {% endif %}
        <div>玩家：{{ s.players|join(', ') }}</div>
        <div>总记录数：{{ s.get('records', s.get('rounds', []))|length }}</div>

        <h5>本场玩家得分</h5>
        <div class="score-list">
            {% for player in s.players_with_ids %}
            <div class="score-item">
                <span>
                    {% if player.id %}
                    <a href="/player/{{ player.id }}" class="player-link{% if player.has_big_gold %} has-big-gold{% elif player.has_small_gold %} has-small-gold{% endif %}">{{ player.name }}</a>：
                    {% else %}
                    {{ player.name }}：
                    {% endif %}
                </span>
                <span class="{% if player.score > 0 %}positive{% elif player.score < 0 %}negative{% else %}neutral{% endif %}">{{ player.score }}</span>
            </div>
            {% endfor %}
        </div>

        <a href="/session_detail/{{ sid }}" class="detail-btn">查看详情</a>
    </div>
    {% else %}
    <div class="card">
        <p class="center">暂无历史记录</p>
    </div>
    {% endfor %}

    <div class="links">
        <a href="/">返回首页</a>
    </div>

    <div class="footer">
        <p>© 2025 EMS Pool Gamble {{ app_version }} |
           <a href="https://github.com/xiaoyuin/EMSPoolGamble" target="_blank" rel="noopener">GitHub</a> |
           <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a>
        </p>
    </div>

<script>
// 通用时区转换工具函数 - 兼容iOS Chrome
function convertUTCToLocal(utcTimeString) {
    if (!utcTimeString || utcTimeString === '未知') {
        return utcTimeString;
    }
    
    try {
        // 统一时间格式处理，兼容iOS Chrome
        let dateString = utcTimeString.trim();
        
        // 如果不是ISO格式且不包含时区信息，则添加Z表示UTC
        if (!dateString.includes('T') && !dateString.endsWith('Z') && !dateString.includes('+') && !dateString.includes(' UTC')) {
            // 将 "YYYY-MM-DD HH:MM:SS" 格式转换为 ISO 格式
            dateString = dateString.replace(' ', 'T') + 'Z';
        } else if (dateString.includes(' UTC')) {
            // 移除 ' UTC' 并替换为 'Z'
            dateString = dateString.replace(' UTC', 'Z').replace(' ', 'T');
        } else if (!dateString.endsWith('Z') && !dateString.includes('+') && !dateString.includes('-', 10)) {
            // 确保有时区标识
            dateString += 'Z';
        }

        // 创建Date对象
        const date = new Date(dateString);
        
        // 检查日期是否有效
        if (isNaN(date.getTime())) {
            console.warn('历史页面时间解析失败:', utcTimeString, '转换后:', dateString);
            return utcTimeString;
        }
        
        // 转换为用户本地时间
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    } catch (error) {
        console.warn('历史页面时间转换失败:', utcTimeString, error);
        return utcTimeString; // 转换失败时返回原值
    }
}

// 页面加载完成后，转换所有时间显示
document.addEventListener('DOMContentLoaded', function() {
    // 转换所有带有 data-utc-time 属性的元素
    document.querySelectorAll('[data-utc-time]').forEach(function(element) {
        const utcTime = element.getAttribute('data-utc-time');
        if (utcTime && utcTime.trim() !== '') {
            const localTime = convertUTCToLocal(utcTime);
            element.textContent = localTime;
            console.log('时间转换:', utcTime, '->', localTime);
        }
    });
    
    console.log('历史记录页面时间转换完成');
});
</script>
</body>
</html>
