<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Pool Gamble - 历史记录</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1em; background-color: #f0f2f5; }
        .card { background: #ffffff; border-radius: 10px; padding: 1.2em; margin-top: 1.5em; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #eee; padding: 0.7em; text-align: center; }
        th { background: #fafafa; font-weight: 500; }
        tr:nth-child(even) { background-color: #fafafa; }
        .header { text-align: center; color: #333; margin-bottom: 1.5em; }
        .links { margin-top: 1em; text-align: center; }
        .links a { color: #1890ff; text-decoration: none; margin: 0 0.5em; }
        .links a:hover { text-decoration: underline; }
        .detail-btn { display: block; padding: 8px 16px; background: #1890ff; color: white; border-radius: 5px; text-decoration: none; margin-top: 1em; text-align: center; width: 100%; box-sizing: border-box; }
        .detail-btn:hover { background: #40a9ff; color: white; text-decoration: none; }
        .footer { margin-top: 2em; text-align: center; font-size: 0.8em; color: #888; }
        .session-header { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .status-active { background: #e6f7ff; color: #1890ff; }
        .status-ended { background: #f5f5f5; color: #666; }
        .score-list { display: flex; flex-wrap: wrap; }
        .score-item { width: 50%; padding: 5px 0; }
        .positive { color: #52c41a; }
        .negative { color: #ff4d4f; }
        .neutral { color: #666; }
        .total-score-table { width: 100%; margin-top: 15px; }
        .total-score-table th { text-align: left; }
        .total-score-table td { text-align: right; }
        .timestamp { font-size: 0.8em; color: #999; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>EMS Pool Gamble - 历史记录</h2>
    </div>

    <!-- 显示消息通知 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card">
        <h3>所有玩家累计分数排名</h3>
        <table class="total-score-table">
            <tr>
                <th>排名</th>
                <th>玩家</th>
                <th>总分</th>
            </tr>
            {% for p, score in total_scores %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ p }}</td>
                <td class="{% if score > 0 %}positive{% elif score < 0 %}negative{% else %}neutral{% endif %}">{{ score }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    {% for sid, s in sessions.items() %}
    <div class="card">
        <div class="session-header">
            <h4>{{ s.get('name', '未命名场次') }}</h4>
            <span class="status-badge {% if s.active %}status-active{% else %}status-ended{% endif %}">
                {{ '活跃' if s.active else '已结束' }}
            </span>
        </div>
        <div>开始时间: {{ s.timestamp }}</div>
        {% if not s.active and s.end_time %}
        <div>结束时间: {{ s.end_time }}</div>
        {% endif %}
        <div>玩家：{{ s.players|join(', ') }}</div>
        <div>观战者：{{ s.viewers|join(', ') }}</div>
        <div>总记录数：{{ s.get('records', s.get('rounds', []))|length }}</div>

        <h5>本场玩家得分</h5>
        <div class="score-list">
            {% for p in s.players|sort(attribute=s.scores.get, reverse=True) %}
            <div class="score-item">
                <span>{{ p }}：</span>
                <span class="{% if s.scores[p] > 0 %}positive{% elif s.scores[p] < 0 %}negative{% else %}neutral{% endif %}">{{ s.scores[p] }}</span>
            </div>
            {% endfor %}
        </div>

        <a href="/session_detail/{{ sid }}" class="detail-btn">查看详情</a>
    </div>
    {% else %}
    <div class="card">
        <p class="center">暂无历史记录</p>
    </div>
    {% endfor %}

    <div class="links">
        <a href="/">返回首页</a>
    </div>

    <div class="footer">
        <p>© 2025 EMS Pool Gamble | <a href="https://github.com/xiaoyuin/EMSPoolGamble" target="_blank" rel="noopener">GitHub</a></p>
    </div>
</body>
</html>
