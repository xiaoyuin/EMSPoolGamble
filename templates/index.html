<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Pool Gamble - å°çƒæ¯”èµ›è®°åˆ†ç³»ç»Ÿ</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1em; background-color: #f0f2f5; }
        .card { background: #ffffff; border-radius: 10px; padding: 1.2em; margin-top: 2em; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .session-card { background: #ffffff; border-radius: 10px; padding: 1em; margin-top: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #1890ff; }
        input, select, button { width: 100%; margin: 0.5em 0; padding: 0.7em; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #1890ff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .header { text-align: center; color: #333; margin-bottom: 1.5em; }
        .header h2 { margin: 0 0 0.3em 0; }
        .flash-message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .flash-success { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .flash-error { background-color: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .footer { margin-top: 2em; text-align: center; font-size: 0.8em; color: #888; }
        .links { margin-top: 1em; text-align: center; }
        .links a { color: #1890ff; text-decoration: none; margin: 0 0.5em; }
        .links a:hover { text-decoration: underline; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .status-active { background: #e6f7ff; color: #1890ff; }
        .status-ended { background: #f5f5f5; color: #666; }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em; }
        .session-name { font-weight: bold; color: #1890ff; font-size: 1.1em; }
        .session-info { color: #666; font-size: 0.9em; margin-bottom: 0.5em; }
        .join-form { margin-top: 0.5em; }
        .section-title { font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 1em; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        .session-actions { display: flex; gap: 0.5em; margin-top: 0.5em; }
        .session-actions button { width: 100%; padding: 0.7em; font-size: 1em; }
        .session-actions .join-form { flex: 1; }
        .ended-session-card { background: #fafafa; border-left: 4px solid #d9d9d9; }
        .ended-session-card .session-name { color: #666; }
        .no-sessions-message { text-align: center; color: #666; }
        .detail-btn { display: block; padding: 8px 16px; background: #1890ff; color: white; border-radius: 5px; text-decoration: none; margin-top: 0.5em; text-align: center; width: 100%; box-sizing: border-box; }
        .detail-btn:hover { background: #40a9ff; color: white; text-decoration: none; }
        .login-status { background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 12px; margin-bottom: 1em; margin-top: 1em;}
        .login-status .user-info { font-weight: bold; color: #1890ff; }
        .login-status .session-info { font-size: 0.9em; color: #666; margin-top: 4px; }
        .logout-btn { display: inline-block; padding: 4px 8px; background: #ff4d4f; color: white; border-radius: 4px; text-decoration: none; font-size: 0.8em; margin-left: 8px; }
        .logout-btn:hover { background: #ff7875; color: white; text-decoration: none; }
        .game-link { color: #1890ff; text-decoration: none; margin-left: 8px; }
        .game-link:hover { text-decoration: underline; }
        .version-info { text-align: center; font-size: 0.75em; color: #999; margin-top: 0; }
        .version-info .version-badge { color: #666; }
        .version-info .build-date { color: #999; margin-left: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>EMS Pool Gamble</h2>
        <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
        <div class="version-info">
            <span class="version-badge">{{ app_version }}</span>
            <span class="build-date">{{ version_date }}</span>
        </div>
        
        <!-- ç®¡ç†å‘˜çŠ¶æ€æ˜¾ç¤º -->
        {% if is_admin_authenticated() %}
        <div class="login-status">
            <div class="user-info">
                ğŸ”“ ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨
                <a href="/admin_logout" class="logout-btn">é€€å‡ºç®¡ç†å‘˜æ¨¡å¼</a>
            </div>
            <div class="session-info">å¯ä»¥æ‰§è¡Œåˆ é™¤ã€ç»“æŸåœºæ¬¡ç­‰å…³é”®æ“ä½œ</div>
        </div>
        {% endif %}
    </div>

    <!-- æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- å¦‚æœæ²¡æœ‰æ´»è·ƒåœºæ¬¡çš„æç¤ºï¼Œç§»åˆ°æœ€ä¸Šé¢ -->
    {% if not active_sessions %}
    <div class="card">
        <p class="no-sessions-message">å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„åœºæ¬¡ï¼Œå¿«æ¥åˆ›å»ºä¸€ä¸ªå§ï¼</p>
    </div>
    {% endif %}

    <!-- æ­£åœ¨è¿›è¡Œçš„åœºæ¬¡åˆ—è¡¨ -->
    {% if active_sessions %}
    <div class="card">
        <div class="section-title">æ­£åœ¨è¿›è¡Œçš„åœºæ¬¡</div>
        {% for session_id, session_data in active_sessions %}
        <div class="session-card">
            <div class="session-header">
                <div class="session-name">{{ session_data.get('name', 'æœªå‘½ååœºæ¬¡') }}</div>
                <span class="status-badge status-active">è¿›è¡Œä¸­</span>
            </div>
            <div class="session-info">
                <div>ç©å®¶ï¼š{{ session_data.players|join(', ') if session_data.players else 'æš‚æ— ç©å®¶' }}</div>
                <div>è®°å½•æ•°ï¼š{{ session_data.get('records', session_data.get('rounds', []))|length }} | å¼€å§‹æ—¶é—´ï¼š<span data-utc-time="{{ session_data.timestamp }}">{{ session_data.timestamp }}</span></div>
            </div>

            <div class="session-actions">
                <form method="post" class="join-form">
                    <input type="hidden" name="action" value="join_session">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="btn-success">è¿›å…¥</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- åˆ›å»ºæ–°åœºæ¬¡ -->
    <div class="card">
        <form method="post" id="create-session-form">
            <input type="hidden" name="action" value="create_session">
            <input type="hidden" name="session_name" id="session-name-input" value="">
            <button type="submit" class="btn-success btn-full" id="create-session-btn">å¿«é€Ÿåˆ›å»º - <span id="suggested-session-name">{{ suggested_session_name }}</span></button>
        </form>
    </div>
    </div>

    <!-- æœ€è¿‘ç»“æŸçš„åœºæ¬¡ -->
    {% if ended_sessions %}
    <div class="card">
        <div class="section-title">æœ€è¿‘ç»“æŸçš„åœºæ¬¡</div>
        {% for session_id, session_data in ended_sessions %}
        <div class="session-card ended-session-card">
            <div class="session-header">
                <div class="session-name">{{ session_data.get('name', 'æœªå‘½ååœºæ¬¡') }}</div>
                <span class="status-badge status-ended">å·²ç»“æŸ</span>
            </div>
            <div class="session-info">
                <div>ç©å®¶ï¼š{{ session_data.players|join(', ') if session_data.players else 'æš‚æ— ç©å®¶' }}</div>
                <div>è®°å½•æ•°ï¼š{{ session_data.get('records', session_data.get('rounds', []))|length }} | ç»“æŸæ—¶é—´ï¼š<span data-utc-time="{{ session_data.get('end_time', 'æœªçŸ¥') }}">{{ session_data.get('end_time', 'æœªçŸ¥') }}</span></div>
            </div>

            <a href="/session_detail/{{ session_id }}" class="detail-btn">æŸ¥çœ‹è¯¦æƒ…</a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="links">
        <a href="/history">æŸ¥çœ‹å†å²è®°å½•</a>
    </div>

    <div class="footer">
        <p>Â© 2025 EMS Pool Gamble | <a href="https://github.com/xiaoyuin/EMSPoolGamble" target="_blank" rel="noopener">GitHub</a></p>
    </div>

<script>
// æ—¶åŒºåç§»é‡å’Œå»ºè®®åœºæ¬¡åç§°å¤„ç†
(function() {
    // ç”ŸæˆåŸºäºç”¨æˆ·æ—¶åŒºçš„å»ºè®®åœºæ¬¡åç§°
    function generateSessionName() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const hour = now.getHours();

        let timePeriod;
        if (hour >= 6 && hour < 11) {
            timePeriod = "ä¸Šåˆ";
        } else if (hour >= 11 && hour < 14) {
            timePeriod = "ä¸­åˆ";
        } else if (hour >= 14 && hour < 18) {
            timePeriod = "ä¸‹åˆ";
        } else {
            timePeriod = "æ™šä¸Š";
        }

        return `${month}æœˆ${day}å·${timePeriod}åœº`;
    }

    // æ›´æ–°å»ºè®®çš„åœºæ¬¡åç§°
    const suggestedNameElement = document.getElementById('suggested-session-name');
    const sessionNameInput = document.getElementById('session-name-input');
    
    if (suggestedNameElement && sessionNameInput) {
        const userSessionName = generateSessionName();
        suggestedNameElement.textContent = userSessionName;
        sessionNameInput.value = userSessionName;
    }

    // è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘æ—¶å¯ç”¨ï¼‰
    console.log('å»ºè®®åœºæ¬¡åç§°:', generateSessionName());
})();

// å°†UTCæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´æ˜¾ç¤º - å…¼å®¹iOS Chrome
function convertUtcToLocal() {
    // è½¬æ¢æ‰€æœ‰å¸¦æœ‰ data-utc-time å±æ€§çš„å…ƒç´ 
    document.querySelectorAll('[data-utc-time]').forEach(function(element) {
        const utcTime = element.getAttribute('data-utc-time');
        if (utcTime && utcTime.trim() !== '' && utcTime !== 'æœªçŸ¥') {
            try {
                // ç»Ÿä¸€æ—¶é—´æ ¼å¼å¤„ç†ï¼Œå…¼å®¹iOS Chrome
                let dateString = utcTime.trim();
                
                // å¦‚æœä¸æ˜¯ISOæ ¼å¼ä¸”ä¸åŒ…å«æ—¶åŒºä¿¡æ¯ï¼Œåˆ™æ·»åŠ Zè¡¨ç¤ºUTC
                if (!dateString.includes('T') && !dateString.endsWith('Z') && !dateString.includes('+') && !dateString.includes(' UTC')) {
                    // å°† "YYYY-MM-DD HH:MM:SS" æ ¼å¼è½¬æ¢ä¸º ISO æ ¼å¼
                    dateString = dateString.replace(' ', 'T') + 'Z';
                } else if (dateString.includes(' UTC')) {
                    // ç§»é™¤ ' UTC' å¹¶æ›¿æ¢ä¸º 'Z'
                    dateString = dateString.replace(' UTC', 'Z').replace(' ', 'T');
                } else if (!dateString.endsWith('Z') && !dateString.includes('+') && !dateString.includes('-', 10)) {
                    // ç¡®ä¿æœ‰æ—¶åŒºæ ‡è¯†
                    dateString += 'Z';
                }

                // åˆ›å»ºDateå¯¹è±¡
                const utcDate = new Date(dateString);
                
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (!isNaN(utcDate.getTime())) {
                    const localTimeStr = utcDate.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    element.textContent = localTimeStr;
                    console.log('é¦–é¡µæ—¶é—´è½¬æ¢:', utcTime, '->', localTimeStr);
                } else {
                    console.warn('é¦–é¡µæ—¶é—´è§£æå¤±è´¥:', utcTime, 'è½¬æ¢å:', dateString);
                }
            } catch (e) {
                console.warn('é¦–é¡µæ—¶é—´è½¬æ¢å¤±è´¥:', utcTime, e);
            }
        }
    });
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ—¶é—´è½¬æ¢
document.addEventListener('DOMContentLoaded', convertUtcToLocal);
</script>
</body>
</html>
