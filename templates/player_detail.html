<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ player.name }} - 玩家详情</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 1em; background-color: #f0f2f5; }
        .card { background: #ffffff; border-radius: 10px; padding: 1.2em; margin-top: 1.5em; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #333; margin-bottom: 1em; }
        .player-name { font-size: 2em; color: #1890ff; margin-bottom: 0.5em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1em; margin: 1em 0; }
        .stat-card { background: #f9f9f9; padding: 1em; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #1890ff; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 0.5em; }
        .flash-message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .flash-success { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .flash-error { background-color: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .rename-form { display: flex; gap: 0.5em; align-items: end; margin-top: 1em; }
        .rename-form input { flex: 1; padding: 0.7em; border: 1px solid #d9d9d9; border-radius: 5px; }
        .btn { padding: 0.7em 1em; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .btn-primary { background: #1890ff; color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-danger { background: #ff4d4f; color: white; }
        .btn-danger:hover { background: #ff7875; }
        .opponents-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .opponents-table th, .opponents-table td { padding: 0.7em; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .opponents-table th { background: #f9f9f9; font-weight: bold; }
        .record-list { max-height: 400px; overflow-y: auto; }
        .record-item { padding: 0.7em; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .record-item:last-child { border-bottom: none; }
        .record-content { flex: 1; }
        .record-result { font-weight: bold; }
        .win { color: #52c41a; }
        .loss { color: #ff4d4f; }
        .timestamp { font-size: 0.8em; color: #999; margin-top: 0.2em; }
        .links { margin-top: 2em; text-align: center; }
        .links a { color: #1890ff; text-decoration: none; margin: 0 0.5em; }
        .links a:hover { text-decoration: underline; }
        .footer { margin-top: 2em; text-align: center; font-size: 0.8em; color: #888; }
        .player-link { color: #1890ff; text-decoration: none; }
        .player-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h2>EMS Pool Gamble - 玩家详情</h2>
        <div class="player-name">{{ player.name }}</div>
        <div style="color: #666; font-size: 0.9em;">
            创建时间: {{ player.created_at }}
            {% if player.updated_at != player.created_at %}
            | 最后更新: {{ player.updated_at }}
            {% endif %}
        </div>
    </div>

    <!-- 显示消息通知 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 统计数据 -->
    <div class="card">
        <h3>统计数据</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_games }}</div>
                <div class="stat-label">总记录</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.wins }}</div>
                <div class="stat-label">胜利</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.losses }}</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "%.1f"|format(stats.win_rate) }}%</div>
                <div class="stat-label">胜率</div>
            </div>
            <div class="stat-card">
                <div class="stat-number {% if stats.total_score > 0 %}win{% elif stats.total_score < 0 %}loss{% endif %}">
                    {{ stats.total_score }}
                </div>
                <div class="stat-label">总分</div>
            </div>
        </div>
    </div>

    <!-- 重命名功能 -->
    <div class="card">
        <h3>重命名玩家</h3>
        <form action="/player/{{ player_id }}/rename" method="post" class="rename-form">
            <input type="text" name="new_name" value="{{ player.name }}" required>
            <button type="submit" class="btn btn-primary">更改名字</button>
        </form>
        <div style="font-size: 0.9em; color: #666; margin-top: 0.5em;">
            注意：更改名字会影响所有历史记录中的显示
        </div>
    </div>

    <!-- 对手统计 -->
    {% if opponents %}
    <div class="card">
        <h3>对手统计</h3>
        <table class="opponents-table">
            <thead>
                <tr>
                    <th>对手</th>
                    <th>总对局</th>
                    <th>胜</th>
                    <th>负</th>
                    <th>胜率</th>
                    <th>总分差</th>
                </tr>
            </thead>
            <tbody>
                {% for opponent in opponents %}
                <tr>
                    <td>
                        <a href="/player/{{ opponent.id }}" class="player-link">{{ opponent.name }}</a>
                    </td>
                    <td>{{ opponent.total_games }}</td>
                    <td class="win">{{ opponent.wins }}</td>
                    <td class="loss">{{ opponent.losses }}</td>
                    <td>{{ "%.1f"|format(opponent.win_rate) }}%</td>
                    <td class="{% if opponent.total_score > 0 %}win{% elif opponent.total_score < 0 %}loss{% endif %}">
                        {{ opponent.total_score }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- 最近记录 -->
    <div class="card">
        <h3>最近对战记录 {% if records|length >= 50 %}(最近50场){% endif %}</h3>
        <div class="record-list">
            {% if records %}
                {% for record in records %}
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-result {% if record.is_winner %}win{% else %}loss{% endif %}">
                            {% if record.is_winner %}
                                胜 <a href="/player/{{ record.opponent_id }}" class="player-link">{{ record.opponent_name }}</a> (+{{ record.score }}分)
                            {% else %}
                                负于 <a href="/player/{{ record.opponent_id }}" class="player-link">{{ record.opponent_name }}</a> (-{{ record.score }}分)
                            {% endif %}
                        </div>
                        <div class="timestamp">
                            {{ record.record.timestamp }} |
                            <a href="/game/{{ record.session_id }}" class="player-link">{{ record.session_name }}</a>
                            {% if record.record.special_score_part %}
                            | {{ record.record.special_score_part }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>暂无对战记录</p>
            {% endif %}
        </div>
    </div>

    <div class="links">
        <a href="/">返回首页</a> |
        <a href="/history">查看历史记录</a>
    </div>

    <div class="footer">
        <p>© 2025 EMS Pool Gamble {{ app_version }} |
           <a href="https://github.com/xiaoyuin/EMSPoolGamble" target="_blank" rel="noopener">GitHub</a> |
           <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener">MIT License</a>
        </p>
    </div>
</body>
</html>
