# 项目上下文说明（Prompt for Agent）

本项目是一个可部署到 Azure 的 Python Flask Web App，主要用于多人台球计分，支持移动端浏览器访问。该应用已完成完整的开发，包含场次管理、详情查看、用户体验优化等功能。

## 项目概述

EMS Pool Gamble 是一个功能完整的多人台球比赛计分系统，特别适合小团队或朋友圈内使用。用户可以选择"玩家"或"观战者"角色参与，系统提供完整的场次管理、实时计分、详情查看和历史记录功能，界面简洁美观，移动端体验优秀。

## 技术栈

- **后端**: Python 3.12 + Flask 3.1.1 + Werkzeug >=3.0.0
- **前端**: HTML + CSS + Jinja2 模板（响应式设计，适配移动端）
- **数据存储**: JSON文件持久化（data.json，应用重启时自动加载）
- **架构模式**: MVC架构，Flask路由作为控制器

## 主要功能

- **完整的场次管理**：支持创建多个命名场次，每个场次可以有独特的名称
- **场次详情页**：专门的详情页展示完整计分记录、玩家排名表格、删除功能
- **主页概览**：显示进行中场次和最近结束的场次，支持快速加入和查看详情
- **安全删除机制**：删除场次功能放在详情页的独立卡片中，避免误操作
- **动态玩家管理**：游戏中可随时添加新玩家，记住最近添加的玩家名单
- **简化计分**：分数范围限定为1-10的正整数，更符合台球计分习惯
- **按钮式操作**：胜者、败者、分数选择全部使用按钮，移动端友好
- **智能缓存**：自动记住用户上次使用的用户名，提升用户体验
- **用户身份**：支持"玩家"和"观战者"两种角色，权限分明
- **一体化记录结构**：取消局的概念，所有计分记录直接存储在场次中
- **实时排名**：动态显示玩家分数排名，使用表格形式展示
- **统一UI设计**：所有页面使用一致的按钮、卡片、链接样式
- **数据持久化**：使用JSON文件存储，应用重启数据不丢失，兼容旧数据格式

## 文件结构

- **app.py**: 主应用逻辑
  - 路由: '/', '/game', '/add_player', '/history', '/end_session', '/logout', '/session_detail/<session_id>', '/delete_session/<session_id>', '/api/scores'
  - 数据处理: 场次管理、分数计算、用户权限控制、场次详情展示
  - 功能: 场次命名、玩家动态添加、用户名缓存、最近玩家记录
  - 数据持久化: 加载/保存JSON文件，完全兼容旧数据格式
- **templates/**: 前端页面模板
  - `index.html`: 首页，显示场次列表、创建新场次、用户登录界面
  - `game.html`: 游戏主界面，按钮式选择、添加玩家、独立退出登录卡片
  - `history.html`: 历史记录页面，概要信息展示，查看详情按钮
  - `session_detail.html`: 场次详情页，完整排名表格、计分记录、删除功能
- **data.json**: 数据存储文件（程序自动创建）
- **requirements.txt**: 项目依赖（已修复版本冲突）
- **README.md**: 项目说明文档
- **PROJECT_CONTEXT.md**: 项目上下文说明

## 数据模型

```python
sessions = {
    "session_id": {
        "name": "周末台球赛",  # 场次名称
        "players": set(),  # 玩家集合
        "viewers": set(),  # 观战者集合
        "records": [  # 计分记录（取消了局的概念）
            {
                "winner": "player1",
                "loser": "player2",
                "score": 5,  # 分数范围：1-10
                "timestamp": "2025-06-22 14:30:00"
            },
            # 更多记录...
        ],
        "scores": defaultdict(int),  # 玩家分数字典，自动初始化为0
        "active": True,  # 场次是否活跃
        "timestamp": "2025-06-22 14:00:00",  # 创建时间
        "end_time": "2025-06-22 16:00:00"  # 结束时间（仅当active=False时）
    }
    # 可能有更多场次...
}

# 全局变量
recent_players = []  # 最近添加的玩家名单（最多10个）
```

## 用户流程

1. 用户访问首页，查看进行中场次列表和最近结束的场次
2. 选择创建新场次（输入场次名称）或加入现有场次（输入用户名和身份）
3. 进入游戏界面，看到当前分数排名和玩家信息
4. 玩家可以：
   - 记录计分（使用按钮选择胜者、败者、分数1-10）
   - 动态添加新玩家到当前场次（支持最近玩家快捷选择）
   - 结束本场比赛
5. 观战者只能查看，不能操作
6. 用户可以：
   - 从主页或历史记录页面点击"查看详情"进入场次详情页
   - 在详情页查看完整的玩家排名表格和所有计分记录
   - 对已结束的场次执行删除操作（在详情页的独立卡片中）

## 已实现特性

- **完整的场次生命周期管理**: 创建 → 进行 → 结束 → 查看详情 → 删除
- **响应式界面**: 适配移动端和桌面浏览器，统一的按钮和卡片设计
- **实时分数排名**: 根据玩家得分进行排序，表格形式展示
- **安全操作设计**: 删除等危险操作放在专门页面，避免误操作
- **数据持久化**: 使用JSON文件存储，完全兼容旧数据格式
- **消息通知系统**: 使用Flask的flash功能提供操作反馈
- **状态指示**: 清晰的活跃/已结束状态显示
- **用户体验优化**: 按钮拉伸、卡片分离、触摸友好设计

## 部署信息

- **环境变量配置**:
  - SECRET_KEY: 会话安全密钥
  - PORT: 应用运行端口（默认5000）
  - FLASK_DEBUG: 调试模式开关（生产环境设为False）
- **默认配置**: 监听0.0.0.0:5000，方便局域网内访问
- **Azure部署**: README中包含Azure App Service部署指南

## 潜在扩展方向

- **数据库集成**: 替换JSON存储为SQLite或PostgreSQL
- **用户认证系统**: 添加账号注册和密码保护
- **多场次并行**: 支持同时进行多个活跃场次
- **撤销功能**: 允许修正记分错误
- **数据可视化**: 添加统计图表展示
- **导出功能**: 支持CSV/PDF格式导出成绩单
- **规则定制**: 支持不同台球游戏规则

## 使用说明

应用已经完成开发，可以直接运行使用。代码结构清晰，有完善注释，容易理解和扩展。如需添加新功能，请在现有代码基础上继续开发，保持代码风格一致。

## 最新更新（2025-06-22）

### 已完成的全部功能开发和优化

#### 核心功能完善
- **场次详情页**：新增 `/session_detail/<session_id>` 路由和对应模板，展示完整信息
- **安全删除机制**：删除场次功能移至详情页，放在独立卡片中，避免主页误操作
- **一体化记录结构**：取消局的概念，所有计分记录统一存储为 `records` 数组
- **最近玩家功能**：记住最近添加的玩家名单，支持快捷添加（最多10个）

#### 用户界面优化
- **统一按钮样式**：所有页面按钮使用一致的宽度和样式，提升视觉统一性
- **按钮式选择**：胜者、败者、分数选择全部改为按钮形式，移动端友好
- **卡片分离设计**：退出登录等功能放在独立卡片中，避免误触
- **响应式布局**：主页"查看详情"按钮、历史页面按钮全部拉伸铺满
- **表格统一**：详情页玩家排名使用与历史页面一致的表格样式

#### 数据兼容性
- **完全向后兼容**：自动处理 `rounds` → `records` 数据格式升级
- **自动初始化**：确保所有玩家在 `scores` 字典中都有条目，使用 `defaultdict`
- **版本升级**：修复 Flask 3.1.1 和 Werkzeug >=3.0.0 版本冲突

#### 代码质量
- **多轮bug修复**：解决用户反馈的各类前后端错误
- **模板语法修复**：修复 Jinja2 模板中的语法错误
- **路由完善**：新增场次详情和删除相关路由
- **错误处理**：完善各种边界情况的处理

### 当前项目状态
- ✅ **功能完整**：所有核心功能开发完成，用户体验优秀
- ✅ **界面统一**：所有页面使用一致的设计语言和交互模式
- ✅ **移动端适配**：完美支持触摸操作和小屏幕显示
- ✅ **数据稳定**：可靠的数据持久化和兼容性处理
- ✅ **部署就绪**：依赖版本正确，可直接部署到 Azure

应用已达到生产可用状态，无需进一步开发。
