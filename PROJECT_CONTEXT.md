# 项目上下文说明（Prompt for Agent）

本项目是一个可部署到 Azure 的 Python Flask Web App，主要用于多人台球计分，支持移动端浏览器访问。该应用已完成基本功能开发，可以直接使用。

## 项目概述

台球计分工具（EMS Pool Gamble）是一个轻量级的多人台球比赛计分系统，特别适合小团队或朋友圈内使用。用户可以选择"玩家"或"观战者"角色参与，系统会记录每局比赛的胜负和得分情况，并提供实时排名和历史数据查询功能。

## 技术栈

- **后端**: Python 3.12 + Flask 3.x + Werkzeug 2.3.x
- **前端**: HTML + CSS + Jinja2 模板（响应式设计，适配移动端）
- **数据存储**: JSON文件持久化（data.json，应用重启时自动加载）
- **架构模式**: MVC架构，Flask路由作为控制器

## 主要功能

- **场次管理**：支持创建多个命名场次，每个场次可以有独特的名称
- **灵活加入**：主页显示所有进行中的场次列表，用户可选择加入任意场次
- **动态玩家管理**：游戏中可随时添加新玩家，无需预先注册
- **简化计分**：分数范围限定为1-10的正整数，更符合台球计分习惯
- **直观操作**：使用按钮网格选择分数，替代下拉菜单，提升移动端体验
- **智能缓存**：自动记住用户上次使用的用户名，提升用户体验
- **用户身份**：支持"玩家"和"观战者"两种角色，权限分明
- **游戏结构**：按"场"与"局"两级记录，一场包含多局，每局有胜负和分数
- **实时排名**：动态显示玩家分数排名和对局历史
- **历史查询**：查看所有场次的详细记录、总排名和分数统计
- **数据持久化**：使用JSON文件存储，应用重启数据不丢失

## 文件结构

- **app.py**: 主应用逻辑
  - 路由: '/', '/game', '/add_player', '/next_round', '/history', '/end_session', '/logout', '/api/scores'
  - 数据处理: 场次管理、分数计算、局数管理、用户权限控制
  - 新功能: 场次命名、玩家动态添加、用户名缓存
  - 数据持久化: 加载/保存JSON文件，兼容旧数据格式
- **templates/**: 前端页面模板
  - `index.html`: 首页，显示场次列表、创建新场次、用户登录界面
  - `game.html`: 游戏主界面，显示当前分数、按钮式分数选择、添加玩家功能
  - `history.html`: 历史记录查询页面，显示场次名称和详细统计
- **data.json**: 数据存储文件（程序自动创建）
- **requirements.txt**: 项目依赖
- **README.md**: 项目说明文档

## 数据模型

```python
sessions = {
    "session_id": {
        "name": "周末台球赛",  # 场次名称（新增）
        "players": set(),  # 玩家集合
        "viewers": set(),  # 观战者集合
        "rounds": [  # 每局记录
            {
                "winner": "player1",
                "loser": "player2",
                "score": 5,  # 分数范围：1-10（修改）
                "timestamp": "2025-06-22 14:30:00",
                "round_number": 1
            },
            # 更多局...
        ],
        "scores": {  # 玩家分数字典
            "player1": 10,
            "player2": 5,  # 只有正数分数（修改）
            # 更多玩家...
        },
        "active": True,  # 场次是否活跃
        "timestamp": "2025-06-22 14:00:00",  # 创建时间
        "end_time": None,  # 结束时间（仅当active=False时）
        "current_round": 3  # 当前局号
    }
    # 可能有更多场次...
}
```

## 用户流程

1. 用户访问首页，查看当前进行中的场次列表
2. 选择创建新场次（输入场次名称）或加入现有场次（输入用户名和身份）
3. 进入游戏界面，看到当前分数和所有局的记录
4. 玩家可以：
   - 记录新的一局（选择胜者/败者，点击1-10分数按钮）
   - 动态添加新玩家到当前场次
   - 开始下一局或结束本场
5. 观战者只能查看，不能操作
6. 用户可随时查看历史记录页面，包含所有场次数据和总排名

## 已实现特性

- **响应式界面**: 适配移动端和桌面浏览器
- **实时分数排名**: 根据玩家得分进行排序
- **美观的UI**: 使用卡片设计和合理配色
- **数据持久化**: 使用JSON文件存储，重启不丢失数据
- **消息通知系统**: 使用Flask的flash功能提供操作反馈
- **状态指示**: 显示当前局数和游戏状态
- **场次管理**: 支持结束场次和查看历史

## 部署信息

- **环境变量配置**:
  - SECRET_KEY: 会话安全密钥
  - PORT: 应用运行端口（默认5000）
  - FLASK_DEBUG: 调试模式开关（生产环境设为False）
- **默认配置**: 监听0.0.0.0:5000，方便局域网内访问
- **Azure部署**: README中包含Azure App Service部署指南

## 潜在扩展方向

- **数据库集成**: 替换JSON存储为SQLite或PostgreSQL
- **用户认证系统**: 添加账号注册和密码保护
- **多场次并行**: 支持同时进行多个活跃场次
- **撤销功能**: 允许修正记分错误
- **数据可视化**: 添加统计图表展示
- **导出功能**: 支持CSV/PDF格式导出成绩单
- **规则定制**: 支持不同台球游戏规则

## 使用说明

应用已经完成开发，可以直接运行使用。代码结构清晰，有完善注释，容易理解和扩展。如需添加新功能，请在现有代码基础上继续开发，保持代码风格一致。

## 最新更新（2025-06-22）

### 新增功能
- **场次命名系统**：每个场次可以设置独特的名称，便于识别和管理
- **主页场次列表**：显示所有正在进行的场次，用户可选择加入任意场次
- **游戏中添加玩家**：在游戏过程中可以临时添加新玩家，无需预先注册
- **用户名缓存**：自动记住用户上次使用的用户名，提升用户体验

### 界面优化
- **按钮式分数选择**：使用5x2网格布局的按钮替代下拉菜单，选择分数更直观
- **响应式设计**：优化移动端显示效果，提升触摸操作体验
- **场次信息展示**：在游戏页面显示场次名称，增强用户归属感

### 计分系统调整
- **简化分数范围**：分数选项调整为1-10的正整数，去除负数，更符合台球计分习惯
- **分数计算逻辑**：胜者加分，败者减分，保持零和游戏特性

### 兼容性
- **数据向后兼容**：自动为旧数据添加默认场次名称，确保升级无痛
- **现有功能保持**：所有原有功能完全保留，只是增强了用户体验
